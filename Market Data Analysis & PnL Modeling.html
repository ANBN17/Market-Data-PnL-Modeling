# ============================================================
# Project 1: Market Data Analysis & PnL Modeling (with graphs)
# ============================================================
# Outputs:
# 1) Normalized price chart
# 2) Daily return histogram (portfolio)
# 3) Equity curves (assets + equal-weight portfolio)
# 4) Rolling annualized volatility (portfolio)
# 5) Drawdowns (assets + portfolio)
# 6) Correlation heatmap
# 7) Console risk summary table
# ============================================================

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

# --- Optional: auto-install yfinance if missing (works in Jupyter) ---
try:
    import yfinance as yf
except ModuleNotFoundError:
    import sys
    import subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "yfinance"])
    import yfinance as yf

# -----------------------------
# 0. Config
# -----------------------------
TICKERS = ["AAPL", "MSFT", "SPY"]
START_DATE = "2020-01-01"
END_DATE = "2024-01-01"
TRADING_DAYS = 252
ROLLING_WINDOW = 63  # ~3 months
RF = 0.0             # risk-free rate (daily assumed 0 here)

plt.style.use("seaborn-v0_8")

# -----------------------------
# 1. Download market data
# -----------------------------
print("Downloading price data...")
prices = yf.download(
    TICKERS,
    start=START_DATE,
    end=END_DATE,
    auto_adjust=True,
    progress=False
)["Close"]

# Handle single ticker shape edge-case
if isinstance(prices, pd.Series):
    prices = prices.to_frame()

prices = prices.dropna(how="all")
prices = prices.ffill().dropna()

print("Prices shape:", prices.shape)
print("\nPrice data preview:")
print(prices.head())

# -----------------------------
# 2. Compute daily returns
# -----------------------------
returns = prices.pct_change().dropna()

# Equal-weight portfolio
weights = np.array([1 / len(TICKERS)] * len(TICKERS))
portfolio_returns = returns.dot(weights)

# Equity curves (growth of $1)
equity_assets = (1 + returns).cumprod()
equity_port = (1 + portfolio_returns).cumprod()

# -----------------------------
# 3. Risk metrics
# -----------------------------
ann_vol_assets = returns.std() * np.sqrt(TRADING_DAYS)
ann_vol_port = portfolio_returns.std() * np.sqrt(TRADING_DAYS)

# Drawdowns
roll_max_assets = equity_assets.cummax()
drawdown_assets = equity_assets / roll_max_assets - 1
max_dd_assets = drawdown_assets.min()

roll_max_port = equity_port.cummax()
drawdown_port = equity_port / roll_max_port - 1
max_dd_port = drawdown_port.min()

# Sharpe (annualized, rf=0)
# daily Sharpe * sqrt(252)
sharpe_assets = (returns.mean() - RF) / returns.std() * np.sqrt(TRADING_DAYS)
sharpe_port = (portfolio_returns.mean() - RF) / portfolio_returns.std() * np.sqrt(TRADING_DAYS)

risk_summary = pd.DataFrame({
    "Ann Return (approx)": returns.mean() * TRADING_DAYS,
    "Ann Vol": ann_vol_assets,
    "Sharpe (rf=0)": sharpe_assets,
    "Max Drawdown": max_dd_assets
}).round(4)

portfolio_summary = pd.DataFrame({
    "Ann Return (approx)": [round(portfolio_returns.mean() * TRADING_DAYS, 4)],
    "Ann Vol": [round(ann_vol_port, 4)],
    "Sharpe (rf=0)": [round(sharpe_port, 4)],
    "Max Drawdown": [round(max_dd_port, 4)]
}, index=["Equal-Weight Portfolio"])

print("\n=== Risk Summary (Assets) ===")
print(risk_summary)

print("\n=== Risk Summary (Portfolio) ===")
print(portfolio_summary)

# -----------------------------
# 4. Graphs
# -----------------------------

# (A) Normalized prices
norm_prices = prices / prices.iloc[0]
plt.figure(figsize=(11, 6))
plt.plot(norm_prices.index, norm_prices.values)
plt.title("Normalized Prices (Start = 1.0)")
plt.ylabel("Normalized Price")
plt.xlabel("Date")
plt.legend(norm_prices.columns)
plt.show()

# (B) Equity curves (assets + portfolio)
plt.figure(figsize=(11, 6))
plt.plot(equity_assets.index, equity_assets.values)
plt.plot(equity_port.index, equity_port.values, linewidth=3)
plt.title("Equity Curves (Growth of $1): Assets + Equal-Weight Portfolio")
plt.ylabel("Growth of $1")
plt.xlabel("Date")
plt.legend(list(equity_assets.columns) + ["Portfolio (Equal-Weight)"])
plt.show()

# (C) Portfolio return distribution (hist)
plt.figure(figsize=(10, 5))
plt.hist(portfolio_returns.values, bins=60)
plt.title("Portfolio Daily Returns Distribution")
plt.xlabel("Daily Return")
plt.ylabel("Frequency")
plt.show()

# (D) Rolling annualized volatility (portfolio)
rolling_vol = portfolio_returns.rolling(ROLLING_WINDOW).std() * np.sqrt(TRADING_DAYS)
plt.figure(figsize=(11, 5))
plt.plot(rolling_vol.index, rolling_vol.values)
plt.title(f"Rolling Annualized Volatility (Portfolio) | Window={ROLLING_WINDOW} days")
plt.ylabel("Annualized Volatility")
plt.xlabel("Date")
plt.show()

# (E) Drawdowns (assets)
plt.figure(figsize=(11, 6))
plt.plot(drawdown_assets.index, drawdown_assets.values)
plt.title("Drawdowns (Assets)")
plt.ylabel("Drawdown")
plt.xlabel("Date")
plt.legend(drawdown_assets.columns)
plt.show()

# (F) Drawdown (portfolio)
plt.figure(figsize=(11, 5))
plt.plot(drawdown_port.index, drawdown_port.values, linewidth=2.5)
plt.title("Drawdown (Equal-Weight Portfolio)")
plt.ylabel("Drawdown")
plt.xlabel("Date")
plt.show()

# (G) Correlation heatmap (no seaborn)
corr = returns.corr()
plt.figure(figsize=(6, 5))
plt.imshow(corr.values, aspect="auto")
plt.title("Return Correlation Heatmap")
plt.xticks(range(len(corr.columns)), corr.columns, rotation=45, ha="right")
plt.yticks(range(len(corr.index)), corr.index)
plt.colorbar()
plt.tight_layout()
plt.show()

print("\nDone. All charts generated.")
